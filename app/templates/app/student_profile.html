{% extends 'app/base.html' %}
{% load static %}

{% block content %}
<style>
    body{
    margin: 0;
    bottom: 0;
}
/* POPUP */
.modal{
    display: none;
    position: fixed;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
}
.modal-content{
    position: relative;
    display: block;
    text-align: center;
    background: white;
    padding: 20px;
    border-radius: 12px;
}
.modal-content .close{
    margin-top: -.6rem;
    padding: .4rem .7rem;
    font-size: 1.2rem;
    border-radius: 50%;
    background-color: #acacac;
    color: whitesmoke;
}
.modal-content h2{
    font-family: 'Courier New', Courier, monospace;
    color: rgb(103, 133, 255);
}
.modal-content form label{
    display: block;
    margin: .5rem;
}
.modal-content form input{
    display: block;
    margin: .5rem;
    width: 12rem;
    height: 1.5rem;
    padding: .5rem 1rem;
    border-radius: 2rem;
    border: 1px solid #333333;
}
.modal-content form select{
    width: 12rem;
    height: 1.5rem;
    border-radius: 2rem;
}
.modal-content form button{
    width: 14rem;
    height: 2.5rem;
    margin-top: .5rem;
    border-radius: 2rem;
}
.modal-content label{
    display: block;
    font-weight: 600;
}
.modal-content input{
    display: block;
    margin: .5rem;
    width: 10rem;
    height: 1.5rem;
    padding: .2rem 1rem;
    border: none;
    border-bottom: 1px solid #333333;
}
.modal-content button{
    width: 14rem;
    height: 2.5rem;
    margin-top: .5rem;
    border-radius: 2rem;
    background-color: rgb(103, 133, 255);
}
.close {
    float: right;
    cursor: pointer;
    font-weight: bold;
}
.card{ 
    padding: 10px; 
    border: 1px solid #ccc; 
    margin: 10px 0; 
    border-radius: 8px; 
}
#addSubjectSection{
    margin: .3rem;
}
#addSubjectSection input{
    padding-left: .8rem;
    border-radius: 3rem;
}
#addSubjectSection button{
    font-weight: 500;
    border-radius: .5rem;
    background-color: rgb(103, 133, 255);
}
#gradeForm{
    text-align: left;
}
#gradeForm label{
    text-align: left;
}
#gradeForm select{
    width: 8rem;
    margin-left: 1.5rem;
}
#gradeForm input{
    width: 4rem;
    height: 1.2rem;
    margin-left: 1.2rem;
}
#gradeEditModal .modal-content{
    text-align: left;
}
#gradeEditModal .modal-content select{
    width: 7rem;
    height: 1.8rem;
    margin-left: 1rem;
    border-radius: 1rem;
}


/* STUDENT PAGE */
.studentpage{
    position: relative;
    display: flex;
    margin: 4rem 20rem;
    width: 55rem;
    height: 35rem;
    max-width: 55rem;
    max-height: 35rem;
    border-radius: 2rem;
    background-color: whitesmoke;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 1);
}
.studentpage_body{
    display: block;
    width: 100%;
    height: auto;
    text-align: center;
}
.studentpage_body h4{
    margin: 0;
    padding: 2rem;
    font-family: 'Courier New', Courier, monospace;
    font-size: 2.5rem;
    color: rgb(103, 133, 255);
}
.studentpage_upper{
    margin-right: 5rem;
    text-align: right;
}
.studentpage_upper button{
    text-transform: uppercase;
    font-size: .8rem;
    font-weight: 600;
    border: none;
    color: whitesmoke;
    border-radius: .7rem;
    background-color: rgb(103, 133, 255);
    cursor: pointer;
}
.studentpage_list{
    text-align: left;
}
.studentpage_list ul{
    width: 45rem;
    height: 26rem;
    margin: .5rem  2rem;
    overflow-y: auto;
}
.studentpage_list ul li{
    display: flex;
    width: 100%;
    height: 5rem;
    max-height: 5rem;
    list-style: none;
    border-top: 1px solid gray;
    border-bottom: 1px solid gray;
    gap: 5rem;
}
.studentpage_list ul li a{
    display: flex;
    align-items: center;
    margin-left: 1rem;
    text-decoration: none;
    font-size: 1.3rem;
    color: black;
}
.studentpage_list ul li a:hover{
    text-decoration: underline;
}
.studentpage_list ul li p{
    margin-top: 2rem
}
#emptyMessage{
    text-align: center;
    font-size: 5rem;
}

/* sTUDENT PROFILE */
.studentprofilepage{
    position: relative;
    display: flex;
    margin: 4rem 20rem;
    width: 55rem;
    height: 35rem;
    max-width: 55rem;
    max-height: 35rem;
    border-radius: 2rem;
    background-color: whitesmoke;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 1);
}
.studentprofile_body{
    display: block;
    width: 100%;
    height: auto;
    padding-bottom: 2rem;
}
.studentprofile_body a{
    margin-left: 1.5rem;
    text-decoration: none;
}
.studentprofile_body a img{
    position: absolute;
    width: 3.5rem;
    height: 3rem;
    margin: .5rem 0;
}
.studentprofile_body a:hover{
    border-bottom: 1px solid #333333;
}
.studentinfo_bottom button{
    color: #333333;
    cursor: pointer;
}
.studentinfo{
    display: flex;
    width: 100%;
    height: 10rem;
    max-height: 10rem;
    padding: 1rem;
}
.studentinfo_image{
    width: 15rem;
    margin-left: 4rem;
}
.studentinfo_image img{
    width: 10rem;
    height: 10rem;
}
.studentinfo_body{
    width: 100%;
}
.studentinfo_profile{
    margin: 1rem;
}
.studentinfo_profile p{
    font-size: 1rem;
}
.studentinfo_profile p:nth-child(1){
    font-family:sans-serif;
    font-size: 2.5rem;
}
.studentinfo_profile p:nth-child(3){
    margin-left: 1rem;
}
.studentinfo_profile p:nth-child(4){
    margin-left: 1rem;
}
.studentinfo_bottom{
    bottom: 0;
    margin-right: 2rem;
    text-align: right;
}
.studentinfo_bottom button{
    text-transform: uppercase;
    border: none;
    background-color: transparent;
}
.studentprofilebody{
    width: 50rem;
    height: 20rem;
    margin: 2rem 2rem;
}
.table-controls{
    margin-bottom: 1rem;
}
.table-controls .studentprofile_uppertable{
    margin-left: .3rem;
    text-transform: uppercase;
    font-size: .8rem;
    font-weight: 100;
    border: none;
    color: whitesmoke;
    border-radius: .7rem;
    background-color: rgb(103, 133, 255);
    cursor: pointer;
}
#subj{
    width: 5rem;
    height: 2rem;
}
#subj select option{
    height: 2rem;
}
#gradesMatrixTable{
    width: 100%;
    border-collapse: collapse;
}
tbody{
    height: 5rem;
    max-height: 5rem;
    overflow-y: auto;
}
#gradesMatrixTable th, #gradesMatrixTable td {
    border: 1px solid #ddd;
    padding: .6rem;
    text-align: center;
}
#gradesMatrixTable th{
    font-size: 1.2rem;
    background-color: rgb(103, 133, 255);;
    color: whitesmoke;
}
#gradesMatrixBody td:nth-child(1){
    font-weight: 600;
}

</style>
<div class="studentprofilepage">
    <div class="studentprofile_body">
        <a href="{% url 'student' %}"><img src="{% static 'images/backk.png' %}" alt=""></a>
        <div class="studentinfo_bottom">
            <button onclick="openStudentEditModal()">Edit</button>
            <div id="studentEditModal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close" onclick="closeStudentEditModal()">&times;</span>
                    <h2>Update Profile</h2>
                    <input type="text" id="firstNameInput">
                    <label>First Name</label>
                    <input type="text" id="lastNameInput">
                    <label>Last Name</label>
                    <input type="text" id="courseInput">
                    <label>Course</label>
                    <input type="text" id="studentNumberInput">
                    <label>Student Number</label>
                    <button onclick="updateStudent()">Save</button>
                </div>
            </div>
            <button onclick="deleteStudent()">Delete</button>
        </div>
        <div class="studentinfo" id="studentInfo">
            <div class="studentinfo_image">
                <img src="{% static 'images/userrr.png' %}" alt="No Image">
            </div>
            <div class="studentinfo_body">
                <div class="studentinfo_profile">
                    <p id="studentNameDisplay"></p>
                </div>
            </div>
        </div>
        <div class="studentprofilebody">
            <div class="table-controls">
                <div id="addSubjectSection" style="display:none;">
                    <input type="text" id="newSubjectInput" placeholder="Enter subject">
                    <button onclick="createSubject()">Save Subject</button>
                </div>
                <button class="studentprofile_uppertable" onclick="toggleAddSubject()">Subject ✚</button>
                <button class="studentprofile_uppertable" onclick="openAddGradeModal()">Grade ✚</button>
                <div id="addGradeModal" class="modal" style="display:none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeAddGradeModal()">&times;</span>
                        <form id="gradeForm">
                            <label>Subject</label>
                            <select id="subj"></select>
                            <label>Grade Type</label>
                            <select id="grade_choices">
                                <option value="Activity">Activity</option>
                                <option value="Quiz">Quiz</option>
                                <option value="Exam">Exam</option>
                            </select>
                            <label>Score</label>
                                <input type="number" id="score" required>
                            <button type="submit">Submit</button>
                        </form>
                    </div>
                </div>
            </div>
            <div id="gradesTableContainer" class="studentprofile_table">
                <table id="gradesMatrixTable">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>Activity</th>
                            <th>Quiz</th>
                            <th>Exam</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="gradesMatrixBody">
                        <div id="gradeEditModal" class="modal" style="display:none;">
                            <div class="modal-content">
                                <span class="close" onclick="closeGradeEditModal()">&times;</span>
                                <h2>Update</h2>
                                <label>Subject</label>
                                <select id="editSubj"></select>
                                <label>Type</label>
                                <select id="editGradeChoices">
                                    <option value="Activity">Activity</option>
                                    <option value="Quiz">Quiz</option>
                                    <option value="Exam">Exam</option>
                                </select>
                                <label>Score</label>
                                <input type="number" id="editScore" step="0.01">
                                <button onclick="updateGrade()">Save</button>
                            </div>
                        </div>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function toggleAddSubject() {
        const section = document.getElementById("addSubjectSection");
        section.style.display = section.style.display === "none" ? "block" : "none";
    }

    function createSubject() {
        const subj = document.getElementById("newSubjectInput").value;
        if (!subj) return alert("Please enter a subject");
        fetch('/api/subjects/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ subj })
        })
        .then(res => res.json())
        .then(newSubj => {
            loadSubjects(newSubj.id);
            document.getElementById("newSubjectInput").value = "";
            document.getElementById("addSubjectSection").style.display = "none";
        });
    }

    function fetchGrades() {
        fetch(`/api/grades/?student=${studentId}`)
        .then(res => res.json())
        .then(data => {
            const grouped = {};
            data.forEach(grade => {
                if (!grouped[grade.subj_name]) {
                    grouped[grade.subj_name] = {
                        subject_id: grade.subj,
                        Activity: null,
                        Quiz: null,
                        Exam: null
                    };
                }
                grouped[grade.subj_name][grade.grade_choices] = grade;
            });
            const tbody = document.getElementById("gradesMatrixBody");
            tbody.innerHTML = '';
            for (const [subjName, grades] of Object.entries(grouped)) {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${subjName}</td>
                    <td>${grades.Activity ? grades.Activity.score : '-'}</td>
                    <td>${grades.Quiz ? grades.Quiz.score : '-'}</td>
                    <td>${grades.Exam ? grades.Exam.score : '-'}</td>
                    <td>
                        ${['Activity', 'Quiz', 'Exam'].map(type =>
                            grades[type] ? `
                                <button onclick="openGradeEditModal(
                                    ${grades[type].id}, 
                                    '${subjName}', 
                                    '${type}', 
                                    ${grades[type].score}
                                )">✏️</button>
                                <button onclick="deleteGrade(${grades[type].id})">🗑️</button>
                            ` : '').join('')}
                    </td>
                `;
                tbody.appendChild(row);
            }
        });
    }


    const studentId = {{ pk }};
    const studentName = document.getElementById("studentName");
    const gradesList = document.getElementById("gradesList");
    const gradeForm = document.getElementById("gradeForm");

    function loadStudent() {
        fetch(`/api/students/${studentId}/`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("studentNameDisplay").innerHTML = `
                    <strong>${data.first_name} ${data.last_name}</strong><br>
                    <p>Student No: ${data.student_number}</p>
                    <p>Course: ${data.course}</p>
                    `;
                document.getElementById("firstNameInput").value = data.first_name;
                document.getElementById("lastNameInput").value = data.last_name;
                document.getElementById("courseInput").value = data.course;
                document.getElementById("studentNumberInput").value = data.student_number;
            });
    }

    function openStudentEditModal() {
        document.getElementById("studentEditModal").style.display = "flex";
    }

    function closeStudentEditModal() {
        document.getElementById("studentEditModal").style.display = "none";
    }

    function updateStudent() {
        const first_name = document.getElementById("firstNameInput").value;
        const last_name = document.getElementById("lastNameInput").value;
        const course = document.getElementById("courseInput").value;
        const student_number = document.getElementById("studentNumberInput").value;

        fetch(`/api/students/${studentId}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                first_name,
                last_name,
                course,
                student_number 
            })
        }).then(() => {
            closeStudentEditModal();
            loadStudent();
            alert('Student updated!');
        });
    }

    function deleteStudent() {
        if (confirm("Are you sure you want to delete this student?")) {
            fetch(`/api/students/${studentId}/`, {
                method: 'DELETE'
            }).then(() => {
                alert("Student deleted");
                window.location.href = "/";
            });
        }
    }

    function loadSubjects(selectedId = null) {
        fetch('/api/subjects/')
            .then(res => res.json())
            .then(data => {
                const subjSelect = document.getElementById("editSubj");
                const addSubjSelect = document.getElementById("subj");
                subjSelect.innerHTML = '';
                addSubjSelect.innerHTML = '';
                data.forEach(subject => {
                    const option1 = document.createElement("option");
                    option1.value = subject.id;
                    option1.textContent = subject.subj;

                    const option2 = document.createElement("option");
                    option2.value = subject.id;
                    option2.textContent = subject.subj;

                    subjSelect.appendChild(option1);
                    addSubjSelect.appendChild(option2);
                });

                if (selectedId) {
                    subjSelect.value = selectedId;
                    addSubjSelect.value = selectedId;
                }
            });
    }

    function openAddGradeModal() {
        document.getElementById("addGradeModal").style.display = "flex";
    }

    function closeAddGradeModal() {
        document.getElementById("addGradeModal").style.display = "none";
    }

    
    function updateGrade() {
        const subj = document.getElementById("editSubj").value;
        const grade_choices = document.getElementById("editGradeChoices").value;
        const score = document.getElementById("editScore").value;
        
        fetch(`/api/grades/${currentGradeId}/`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student: studentId,
                subj,
                grade_choices,
                score
            })
        }).then(() => {
            closeGradeEditModal();
            fetchGrades();
            alert('Grade has been updated')
        });
    }

    function deleteGrade(id) {
        fetch(`/api/grades/${id}/`, {
            method: 'DELETE'
        }).then(fetchGrades);
    }

    gradeForm.addEventListener("submit", e => {
        e.preventDefault();
        const subj = parseInt(document.getElementById("subj").value);
        const grade_choices = document.getElementById("grade_choices").value;
        const score = parseFloat(document.getElementById("score").value);
        
        fetch('/api/grades/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                student: studentId,
                subj,
                grade_choices,
                score
            })
        })
        .then(res => {
            if (!res.ok) return res.json().then(err => { throw err });
            return res.json();
        })
        .then(() => {
            gradeForm.reset();
            fetchGrades();
            closeAddGradeModal();
        })
        .catch(err => {
            console.error("Error adding grade:", err);
            alert("Invalid input. Please check all fields.");
        });
    });


    let currentGradeId = null;

    function openGradeEditModal(id, subj_name, grade_choices, score) {
        currentGradeId = id;
        document.getElementById("editGradeChoices").value = grade_choices;
        document.getElementById("editScore").value = score;
        document.getElementById("gradeEditModal").style.display = "flex";

        fetch('/api/subjects/')
        .then(res => res.json())
        .then(subjects => {
            const subjSelect = document.getElementById("editSubj");
            console.log('subjSelect:', subjSelect);
            console.log('subjects:', subjects);

            subjSelect.innerHTML = '';
            subjects.forEach(subject => {
                const option = document.createElement("option");
                option.value = subject.id;
                option.textContent = subject.subj;
                if (subject.subj.toLowerCase() === subj_name.toLowerCase()) {
                    option.selected = true;
                }
                subjSelect.appendChild(option);
            });
        });
    }

    function closeGradeEditModal() {
        document.getElementById("gradeEditModal").style.display = "none";
    }

    loadStudent();
    loadSubjects();
    fetchGrades();
</script>

{% endblock content %}